<html>

<head>
  <meta name="apple-mobile-web-app-capable" content="yes">

  <script src="./vendor.js"></script>
  <script src="./bower_components/webcomponentsjs/webcomponents-loader.js"></script>
  <link rel="import" href="x-camera.html">

  <style>
    x-camera {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
  </style>
</head>

<body>
  <a-scene physics="debug:false;restitution: 0.55">
    <a-assets>
      <a-asset-item id="ball-img" src="assets/germany2006.jpg"></a-asset-item>
    </a-assets>

    <a-entity loock-controls camera="userHeight: 1.6" position="0 0 0"></a-entity>

    <a-plane id="ground" static-body position="0 0 -4" visible="false" rotation="-90 0 0" width="50" height="100"></a-plane>

    <a-sphere id="ball" dynamic-body="shape: sphere; mass: 1" position="0 2.4 -0.5" radius=".11" src="#ball-img"></a-sphere>

    <!--goal-->
    <a-entity position="0 0 -20" id="goal">
      <a-cylinder static-body height="2.4" radius=".06" position="-3.5 1.2 0"></a-cylinder>
      <a-cylinder static-body height="2.4" radius=".06" position="3.5 1.2 0"></a-cylinder>
      <a-cylinder static-body height="7.06" radius=".06" position="0 2.4 0" rotation="0 0 90"></a-cylinder>
      <a-plane static-body width="1" height="2.4" rotation="0 90 0" position="-3.5 1.2 -.5" transparent="true" opacity="0.5" material="side: double"></a-plane>
      <a-plane static-body width="1" height="2.4" rotation="0 -90 0" position="3.5 1.2 -.5" transparent="true" opacity="0.5" material="side: double"></a-plane>
      <a-plane static-body width="1" height="7.06" rotation="90 0 90" position="0 2.4 -.5" transparent="true" opacity="0.5" material="side: double"></a-plane>
      <a-plane static-body width="7.06" height="2.4" position="0 1.2 -1" transparent="true" opacity="0.5" material="side: double"></a-plane>
      <a-plane static-body position="0 0 -5" visible="false" width="50" height="50"></a-plane>
    </a-entity>

    <x-camera></x-camera>

    <script>
      document.addEventListener('keydown', function(e) {
        if (e.keyCode === 32) kickTheBall();
      });

      document.addEventListener('touchstart', ontouchstart, {
        passive: true
      });

      document.addEventListener('touchend', ontouchend, {
        passive: true
      });

      document.addEventListener('mousedown', ontouchstart);
      document.addEventListener('mouseup', ontouchend);

      let netsBodies;
      setTimeout(function() {
        netsBodies = Array.from(goal.querySelectorAll('a-plane')).map(el => el.body);
        ball.body.addEventListener('collide', oncollide);
      }, 1000);


      function oncollide(e) {
        if (ground.body === e.body) return;
        if (netsBodies.indexOf(e.body) !== -1) {
          console.log('gooooooooooalll');
        } else {
          console.log('Player has collided with body #', e.body);
        }
        ball.body.removeEventListener('collide', oncollide);
        setTimeout(restart, 1000);
      }

      function restart() {
        ball.body.force = new CANNON.Vec3(0, 0, 0);
        ball.body.velocity = new CANNON.Vec3(0, 0, 0);
        ball.body.torque = new CANNON.Vec3(0, 0, 0);
        ball.body.angularVelocity = new CANNON.Vec3(0, 0, 0);
        ball.body.position = new CANNON.Vec3(0, 2.4, -.5);
        netsBodies = Array.from(goal.querySelectorAll('a-plane')).map(el => el.body);
        ball.body.addEventListener('collide', oncollide);
      }

      const lastTouchPosition = {
        x: 0,
        y: 0,
        time: 0
      };
      const maxX = window.innerWidth;
      const maxY = window.innerHeight;
      const maxTime = 1000;

      function ontouchstart(event) {
        const touch = getTouch(event);
        lastTouchPosition.pageX = touch.pageX;
        lastTouchPosition.pageY = touch.pageY;
        lastTouchPosition.time = performance.now();
      }

      function ontouchend(event) {
        const touch = getTouch(event);
        const deltaY = (touch.pageY - lastTouchPosition.pageY) / maxY;
        if (deltaY > 0) return;
        const deltaX = (touch.pageX - lastTouchPosition.pageX) / maxX;
        const deltaTime = 1000 / Math.min(maxTime, performance.now() - lastTouchPosition.time);

        const forceX = deltaX * 300;
        const forceY = 0;
        const forceZ = 200 * deltaY * deltaTime;

        // const forceX = Math.random() * 100 - 200;
        // const forceY = Math.random() * 250 - 500;
        // const forceZ = -(Math.random() * 1000 + 500);
        console.log(forceX, forceY, forceZ);
        ball.body.applyForce(
          new CANNON.Vec3(forceX, forceY, forceZ),
          new CANNON.Vec3().copy(ball.body.position));
      }

      function getTouch(event) {
        if (event.touches && event.touches[0]) return event.touches[0];
        if (event.targetTouches && event.targetTouches[0]) return event.targetTouches[0];
        if (event.changedTouches && event.changedTouches[0]) return event.changedTouches[0];
        return event;
      }
    </script>
  </a-scene>
</body>

</html>